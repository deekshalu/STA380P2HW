---
title: "Cap Metro Storytelling"
author: "Deeksha R Koonadi, Sonali Hornick"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(tidyr)
library(corrplot)
library(dbscan)
```

## Visual story telling part 2: Capital Metro data

The file capmetro_UT.csv contains data from Austin's own Capital Metro bus network, including shuttles to, from, and around the UT campus. These data track ridership on buses in the UT area. Ridership is measured by an optical scanner that counts how many people embark and alight the bus at each stop. Each row in the data set corresponds to a 15-minute period between the hours of 6 AM and 10 PM, each and every day, from September through November 2018. The variables are: \newline

*timestamp*: the beginning of the 15-minute window for that row of data \newline
*boarding*: how many people got on board any Capital Metro bus on the UT campus in the specific 15 minute window \newline
*alighting*: how many people got off ("alit") any Capital Metro bus on the UT campus in the specific 15 minute window \newline
*day_of_week and weekend*: Monday, Tuesday, etc, as well as an indicator for whether it's a weekend. \newline
*temperature*: temperature at that time in degrees F \newline
*hour_of_day*: on 24-hour time, so 6 for 6 AM, 13 for 1 PM, 14 for 2 PM, etc.\newline
*month*: July through December \newline

**Objective) Your task is to create a figure, or set of related figures, that tell an interesting story about Capital Metro ridership patterns around the UT-Austin campus during the semester in question. Provide a clear annotation/caption for each figure, but the figure(s) should be more or less stand-alone, in that you shouldn't need many, many paragraphs to convey its meaning. Rather, the figure together with a concise caption should speak for itself as far as possible.**

Note: You have broad freedom to look at any variables you'd like here -- try to find that sweet spot where you're showing genuinely interesting relationships among more than just two variables, but where the resulting figure or set of figures doesn't become overwhelming/confusing. (Faceting/panel plots might be especially useful here.) \newline

```{r day&boarding_boxplot}
capmetro <- read.csv("capmetro_UT.csv")
head(capmetro, n=5)


#is.factor(capmetro$day_of_week)
# day_order <- c("Sunday", "Monday", "Tuesday", "Wednesday","Thursday", "Friday", "Saturday") 
# capmetro$day_of_week <- factor(capmetro$day_of_week, levels = day_order)

#is.factor(capmetro$day_of_week)
#levels(capmetro$day_of_week)
capmetro$day_of_week <- factor(capmetro$day_of_week, levels = c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"))
# levels(week_order)

ggplot(capmetro, aes(x = day_of_week, y = boarding, fill = day_of_week, order=day_of_week)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#FF0066", "#FF6699", "#FF3366", "#FF0033", "#CC0066", "#FF3399", "#FF0099")) +  # Set custom colors
  labs(
    x = "Day of the Week", 
    y = "Number Boarding", 
    title = "Boarding stats based on day of the week", 
    caption = "The boxplots for the weekdays appear to be more similar in their larger structure 
    and spread than the boxpots for weekends. This could be because students are more likley to 
    have classes during the weekdays and as such will need to use the UT bus system more often 
    on those days. On the weekends they might not have much use for the UT bus."
    ) 


```

```{r doublebargraph}

capmetro_long <- capmetro %>%
  pivot_longer(cols = c(boarding, alighting), names_to = "type", values_to = "count")


ggplot(capmetro_long, aes(x = day_of_week, y = count, fill = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("boarding" = "#000066", "alighting" = "#99CCFF")) +  # Set custom colors
  labs(
    x = "Day of the Week", 
    y = "Count", 
    title = "Boarding and Alighting Stats by Day of the Week", 
    caption = "Like the boxplots, there are more values for the weekdays. There is no constant or 
    clear pattern between boarding and alighting; however, this could be due to further dependencies
    between temperature or hour of the day. If it is not as hot or if it is busy, students may potentiialy
    be walking instead of using the bus."
    ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45))  # Rotate x-axis labels for better readability
```

```{r corrheatmap}
numeric_cols <- capmetro[sapply(capmetro, is.numeric)]
corr_matrix <- cor(numeric_cols, use = "complete.obs")

# Plot the correlation matrix
corrplot(corr_matrix, 
         method = "color", 
         col = colorRampPalette(c("#CCFF66","#669933", "#003300"))(200), 
         addCoef.col = "white", 
         tl.col = "black", 
         tl.srt = 45, 
         title = "Correlation Matrix Heatmap", 
        caption = "The correlation heatmap can help us to see if there are any 
        strong relationships between variables. For example we can see if there 
        is a correlation between boarding and temperature. Some observations 
        from the heatmap that we can see is how boarding has the most and the 
        strongest correlation with the other variables than the other variables 
        do with each other.")
```

The correlation heatmap can help us to see if there are anystrong relationships between variables. For example we can see if there is a correlation between boarding and temperature. Some observations from the heatmap that we can see is how boarding has the most and the strongest correlation with the other variables than the other variables do with each other.

```{r monthlystats}
capmetro$month = factor(month(capmetro$timestamp, label = TRUE),
                        levels = c("Sep", "Oct", "Nov")) 
par(mfrow = c(1,2))
ggplot(capmetro, aes(x = month, y = boarding, fill = month)) +
  geom_boxplot() +
  labs(title = "Monthly Boarding Patterns",
       x = "Month",
       y = "Number of People Boarding") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(capmetro, aes(x = month, y = alighting, fill = month)) +
  geom_boxplot() +
  labs(title = "Monthly Alighting Patterns",
       x = "Month",
       y = "Number of People Alighting") +
  scale_fill_brewer(palette = "Set3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
The boxplot for boarding has a larger spread/range than the boxplot for the alighting. Both boxplots also have quite a few
outliers with alighting having more than boarding. 


```{r pairsplot}
capmetro <- read.csv("capmetro_UT.csv")
temperature <- capmetro$temperature
boarding <- capmetro$boarding
alighting <- capmetro$alighting
hour_of_day <- capmetro$hour_of_day
pairs(~ boarding + alighting + hour_of_day + temperature, data = capmetro)

```

This graph was not a big part of our answer for this question but we did it to explore the relationships between all the variables in our dataset in the form of scatterplots. We can see how some have greater variance and how others dont have the variance and are instead spread in vertical lines. 

```{r}


yearly_usage_stats = capmetro %>% group_by(month = month(timestamp)) %>% summarise(avgBoarding = mean(boarding), avgAlighting = mean(alighting))


capmetro$month = month(capmetro$timestamp, label = TRUE)


mean_temperature = aggregate(temperature ~ month, data = capmetro, FUN = mean)

captionText = "Temperature plays an interesting factor in this dataset. Even though temperatures
start to decreases towrds November, the range/spread of students using the UT bus system stays 
about constant and does not increase. It does slightly increase between September to October but 
then falls back to regulalr values in November. This could be due to students traveling or having
holidays and not having a greater need for the bus."
wrappedCaption = str_wrap(captionText, width = 80) 


boardingPlot = ggplot(capmetro, aes(x = month, y = boarding, fill=month)) +
  geom_boxplot( )+
  scale_fill_brewer(palette = "Pastel1")
  theme_minimal()


scalingFactor = max(capmetro$boarding) / max(mean_temperature$temperature)


boardingPlot +
  geom_line(data = mean_temperature, aes(x = month, y = temperature * scalingFactor, group = 1), color = "black") +
  scale_y_continuous(name = "Boarding Numbers",
                     sec.axis = sec_axis(trans = ~ . / scalingFactor, name = "Mean Temperature (Â°C)")) +
  labs(title = "Boarding Numbers and Mean Temperature by Month",
       x = "Month",
       caption = wrappedCaption) + 
  theme(plot.caption = element_text(hjust = 0)) 
```

These are the graphs we selected to explore and display the relationships between different variables in the capmetro dataset. We found some interesting and surprising conclusions and the relationship between the time of the year, the temperature, and etc... and how it influences boarding and alighting stats. 

